#! /bin/bash

# oc cluster up --public-hostname 127.0.0.1
# minishift start

oc login -u system:admin
oc adm policy add-cluster-role-to-user cluster-admin developer
oc login -u developer -p developer
oc new-project chat
oc project chat
oc new-app --docker-image=mongo

oc new-app --docker-image=chatback \
           -e PROTOCOL=http \
           -e PORT=3000 \
           -e MONGO_SERVICE_HOST=mongo \
           -e JWT_SECRET=somefoo

# set the image pull policy to "Never" since we want to use the local docker image generated by our build
# the first deployment will fail, but the next time around should work
oc patch dc/chatback -p '{"spec": {"template": {"spec": {"containers": [{"imagePullPolicy": "Never", "name": "chatback"}]}}}}'
oc deploy chatback

oc expose service chatback

# the tester pod
oc new-app --docker-image=cb_test \
           -e PROTOCOL=http \
           -e MONGO_SERVICE_HOST=mongo \
           -e PORT=3000 \
           -e JWT_SECRET=somefoo \
           -e SERVER_HOST=chatback

# set the image pull policy to "Never" since we want to use the local docker image generated by our build
oc patch dc/cb_test -p '{"spec": {"template": {"spec": {"containers": [{"imagePullPolicy": "Never", "name": "chatback"}]}}}}'
oc deploy cb_test
